name: CI-CD-to-AWS-ElasticBeanstalk

on:
  push:
    branches: [ "master" ]

env:
  AWS_REGION                 : "eu-north-1"
  EB_PACKAGE_S3_BUCKET_NAME  : "crazycook-application-packages" 
  EB_APPLICATION_NAME        : "Crazycook-test" 
  EB_ENV_NAME                : "Crazycook-test-env"
  DEPLOY_PECKAGE_NAME        : "crazycook_app_${{ github.sha }}.zip"


jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    steps:
    - name: git clone repo
      uses: actions/checkout@v1

    - name: create zip deployment package
      run : zip -r ${{env.DEPLOY_PECKAGE_NAME}} ./ -x *.git*

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with: 
        aws-access-key-id: ${{secrets.MY_AWS_ACCESS_KEY}}
        aws-secret-access-key: ${{secrets.MY_AWS_SECRET_KEY}}
        aws-region: ${{env.AWS_REGION}}
        
    - name: Copy deployment package to s3 bucket
      run : aws s3 cp ${{ env.DEPLOY_PECKAGE_NAME }} s3://${{ env.EB_PACKAGE_S3_BUCKET_NAME }}/

    - name: Print Heppy message for CI complete
      run : echo "CI finished successfully"

  cd-pipeline:
    runs-on: ubuntu-latest
    needs: [ci-pipeline]
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with: 
        aws-access-key-id: ${{secrets.MY_AWS_ACCESS_KEY}}
        aws-secret-access-key: ${{secrets.MY_AWS_SECRET_KEY}}
        aws-region: ${{env.AWS_REGION}}

    - name: Create a new Elastic Beanstalk app
      run : |
        aws elasticbeanstalk create-application-version \
        --application-name ${{ env.EB_APPLICATION_NAME }} \
        --source-bundle S3Bucket="${{ env.EB_PACKAGE_S3_BUCKET_NAME }}",S3Key="${{ env.DEPLOY_PECKAGE_NAME }}" \
        --version-label "Ver-${{ github.sha }}" \
        --description "CommitSHA-${{ github.sha }}"

    - name: Deploy a new Elastic Beanstalk app version
      run : aws elasticbeanstalk update-environment --environment-name ${{env.EB_ENV_NAME}} --version-label "Ver-${{github.sha}}"
    
    - name: Print Heppy message for CD complete
      run : echo "CD finished successfully"
